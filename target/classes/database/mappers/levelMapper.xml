<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.food.sbproject1.level.LevelMapper">
  	<sql id="getLevelList">
  			title like concat('%', #{search}, '%') or
  			writer like concat('%', #{search}, '%') or
  			contents like concat('%', #{search}, '%')
  	</sql>
  	
  	
  	<select id="getCount" resultType="long" parameterType="pager">
  		select count(num) from level where
  		<include refid="getLevelList"></include>
  	</select>
  	
  	<select id="getList" resultType="LevelVO" parameterType="pager">
  		select * from level where
  		<include refid="getLevelList"></include>
  		order by num desc limit #{startRow}, 10
  	</select>
  	
  	<insert id="setInsert" parameterType="LevelVO">
  		insert into level (title, writer, contents, regDate, hit, ref, step, depth)
  		values(#{title}, #{writer}, #{contents}, now(), 0, 0, 0, 0)
  	</insert>
  	
  	<select id="getSelect" parameterType="LevelVO" resultType="LevelVO">
  		select * from level
		where num=#{num}
  	</select>
  	
  	
  	<update id="setUpdate" parameterType="LevelVO">
  		update level set title=#{title}, contents=#{contents} where num=#{num}
  	</update>
  	
  	<delete id="setDelete" parameterType="LevelVO">
  		delete from level where num=#{num}
  	</delete>
  	
  	<insert id="setReply" parameterType="LevelVO">
  		insert into level(title, writer, contents, regDate, hit) values (#{title}, #{writer}, #{contents}, now(), 0
		(select ref from level where num=#{num}), 
		(select step+1 from level where num=#{num}),
		(select depth+1 from level where num=#{num}))
  	</insert>
  	
   	<update id="setUpdateReply" parameterType="LevelVO">
  		update level set step = step+1
  		where ref = (select ref from level where num =# {num})
  		and step> (select step from level where num =# {num})
  	</update> 
  </mapper>